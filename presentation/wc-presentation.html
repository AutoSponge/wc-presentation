<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="components/marked-element/marked-element.html">
<link rel="import" href="components/core-ajax/core-ajax.html">
<link rel="import" href="components/font-roboto/roboto.html">
<link rel="import" href="components/paper-progress/paper-progress.html">
<link rel="import" href="components/paper-input/paper-input.html">
<link rel="import" href="components/core-icons/core-icons.html">

<!-- external script file dependencies -->
<script src="components/mousetrap/mousetrap.min.js"></script>
<script src="components/prismjs/prism.js"></script>

<polymer-element name="wc-presentation" on-key-right="{{next}}" on-key-left="{{prev}}" attributes="url markdown raw">

    <template>
        <style>
            :host {
                position: absolute;
                width: 100%;
                height: 100%;
                box-sizing: border-box;
            }

            #presentation {
                width: 100%;
                height: 100%;
                left: 0;
                top: 0;
                position: absolute;
                font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
            }

            paper-progress {
                display: block;
                width: 100%;
                padding: 0;
            }

            #controls paper-input {
                width: 30px;
            }

            #controls core-icon:hover {
                fill: #fb8c00;
            }

            #controls paper-input /deep/ input {
                text-align: center;
            }

            article.slide {
                display: block;
                padding: 25px;
            }

            .markdown {
                font-size: 36px;
                font-weight: normal;
                letter-spacing: -0.02em;
                color: black; }

            ::selection {
                color: white;
                background: rgba(0, 0, 0, 0.99);
                text-shadow: none; }

            .markdown .slides > section,
            .markdown .slides > section > section {
                line-height: 1.2em;
                font-weight: inherit; }

            /*********************************************
             * HEADERS
             *********************************************/
            .markdown h1,
            .markdown h2,
            .markdown h3,
            .markdown h4,
            .markdown h5,
            .markdown h6 {
                margin: 0.5em 0 0.5em 0;
                color: black;
                line-height: 1em;
                letter-spacing: 0.02em;
                text-align: center;
                text-transform: none;
                text-shadow: none;
                word-wrap: break-word; }

            .markdown h1 {
                font-size: 3.77em; }

            .markdown h2 {
                font-size: 2.11em; }

            .markdown h3 {
                font-size: 1.55em; }

            .markdown h4 {
                font-size: 1em; }

            .markdown h1 {
                text-shadow: 0 0 1em rgba(0, 0, 0, 0.2); }

            .markdown p {
                margin: 0.2em 4em;
                line-height: 1.2em; }

            .markdown img,
            .markdown video,
            .markdown iframe {
                max-width: 95%;
                max-height: 95%; }

            .markdown strong,
            .markdown b {
                font-weight: bold; }

            .markdown em {
                font-style: italic; }

            .markdown ol,
            .markdown dl,
            .markdown ul {
                text-align: left;
                display: inline-block;
                margin: 0.2em 3.8em; }

            .markdown ol {
                list-style-type: decimal;
                margin: 0.2em 4.2em;}

            .markdown ul {
                list-style-type: disc; }

            .markdown ul ul {
                list-style-type: square; }

            .markdown ul ul ul {
                list-style-type: circle; }

            .markdown ul ul,
            .markdown ul ol,
            .markdown ol ol,
            .markdown ol ul {
                display: block;
                margin-left: 1em; }

            .markdown dt {
                font-weight: bold; }

            .markdown dd {
                margin-left: 1em; }

            .markdown q,
            .markdown blockquote {
                quotes: none; }

            .markdown blockquote {
                display: block;
                position: relative;
                width: 70%;
                margin: 1em auto;
                padding: 1em;
                font-style: italic;
                background: rgba(255, 255, 255, 0.05);
                box-shadow: 0 0 1em rgba(0, 0, 0, 0.2); }

            .markdown blockquote p:first-child,
            .markdown blockquote p:last-child {
                display: inline-block; }

            .markdown q {
                font-style: italic; }

            .markdown pre {
                display: block;
                position: relative;
                width: 90%;
                margin: 1em auto;
                text-align: left;
                font-size: 0.55em;
                font-family: monospace;
                line-height: 1.2em;
                word-wrap: break-word;
                box-shadow: 0 0 1em rgba(0, 0, 0, 0.3); }

            .markdown code {
                border: 1px solid #ddd;
                background-color: #f8f8f8;
                padding: 0.1em 0.2em;
                font-family: monospace; }

            .markdown pre code {
                display: block;
                padding: 5px;
                overflow: auto;
                max-height: 400px;
                word-wrap: normal;
                background: #3F3F3F;
                color: #DCDCDC; }

            .markdown a {
                color: #4183c4;
                text-decoration: none; }

            .markdown a:hover {
                color: #53acff; }

        </style>

        <!-- external css -->
        <link rel="stylesheet" href="components/prismjs/prism-okaidia.css">

        <!-- import the list of slides -->
        <core-ajax
                auto
                url="{{ url }}"
                handleAs="document"
                on-core-response="{{ handleFilesList }}"></core-ajax>

        <!-- start the presentation section -->
        <section id="presentation" layout vertical>

            <!-- display progress -->
            <paper-progress value="{{ selected + 1 }}" min="0" max="{{ files.length }}"></paper-progress>

            <!-- the presentation's main content area -->
            <section id="content" flex relative>

                <!-- the presentation's pages -->
                <core-animated-pages id="slides" transitions="slide-from-right" selected="{{ selected }}" notap>

                    <template repeat="{{ file in files }}">
                        <article class="slide" horizontal layout center-justified>
                            <core-ajax
                                    auto
                                    url="{{ url + file.name }}"
                                    handleAs="text"
                                    response="{{ file.body }}"></core-ajax>
                            <template if="{{ file.extension | matchExtension('markdown') }}">
                                <marked-element class="markdown" text="{{ file.body }}"></marked-element>
                            </template>
                            <template if="{{ file.extension | matchExtension('raw') }}">
                                {{ file.body }}
                            </template>
                        </article>
                    </template>

                </core-animated-pages>
                <!-- end presentation's pages -->

            </section>
            <!-- end presentation's main content area -->

            <section id="controls" horizontal layout center-justified>
                <core-icon icon="icons:arrow-back" on-click="{{prev}}"></core-icon>
                <paper-input value="{{ selected }}"></paper-input>
                <core-icon icon="icons:arrow-forward" on-click="{{next}}"></core-icon>
            </section>

        </section>
        <!-- end the presentation section -->

    </template>

    <script>

        Polymer( 'wc-presentation', {
            keys: ['right', 'left'],
            next: function ( /*e, data, sender*/ ) {
                if ( this.selected < this.files.length - 1 ) {
                    this.selected += 1;
                }
            },
            prev: function ( /*e, data, sender*/ ) {
                if ( this.selected > 0 ) {
                    this.selected -= 1;
                }
            },
            keyHandler: function ( e, data ) {
                this.asyncFire( 'key-' + data, {event: e, key: data} );
            },
            ready: function () {
                //setup key bindings
                Mousetrap.bind( this.keys, this.keyHandler.bind( this ) );

                //create lists of file types by parser
                ['markdown', 'raw'].reduce( function ( obj, type ) {
                    obj[type + 'List'] = obj[type].split( /,\s*/ );
                    return obj;
                }, this );
            },
            matchExtension: function ( value, type ) {
                return this[type + 'List'].some( function ( valid ) {
                    return valid === value;
                } );
            },
            handleFilesList: function ( e, data/*, sender*/ ) {
                var i = 0;
                this.files = [];
                [].slice.call( data.response.querySelectorAll( 'li' ), 0 ).reduce( function ( files, li ) {
                    var name = li.innerText.trim();
                    files.push( {
                        name: name,
                        index: i++,
                        extension: name.split( '.' )[1]
                    } );
                    return files;
                }, this.files );
            }
        } );

    </script>

</polymer-element>